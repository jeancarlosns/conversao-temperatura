name: CI/CD Pipeline

on:
  push:
    branches:
      - master
    - name: Deploy Ambiente de Preview
    run: |
      kubectl create namespace preview-${{ github.head_ref }} || true
      kubectl apply -f k8s/deployment.yaml -n preview-${{ github.head_ref }}

  - name: Executar Testes de Preview
    run: npm test

destroy-preview:
  runs-on: ubuntu-latest
  if: github.event.action == 'closed' || github.event.action == 'unlabeled' || github.event.action == 'merged'

  steps:
    - name: Instalar Kubectl
      run: |
        curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x ./kubectl
        sudo mv ./kubectl /usr/local/bin/kubectl

    - name: Destruir Ambiente de Preview
      run: |
        kubectl delete namespace preview-${{ github.head_ref }} || true
